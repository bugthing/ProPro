<% content_for :custom_head_tag do %>
  <%= javascript_include_tag "vendor/jquery.jsPlumb-1.3.16-all.js" %>
<% end %>

<div id="builder" style="display: none;" class=span12></div>

<div class="span3">
  <div class="well" id="section-builder">
    <h2> Sections </h2>
    <i> 
      Use the chart builder on the right to 
      add sections the edit them in this area
    </i>
  </div>
</div>

<div class="span8 well" id="chart-builder">

  <h1> <%= @chart.name %> </h1>

    <% 
      @chart.sections.each_with_index do |section, i| 
    %>

      <div id="section-<%=section.id%>" class='chart-section' >
        <div class="dropdown clearfix">
           <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu" style="display: block; position: static; margin-bottom: 5px; *width: 180px;">
             <li> <%= section.name %>(<%= section.id %>) </li>
             <li class="">
             </li>
           </ul>
           <div>
                <a  href='javascript: doSectionEdit( <%= section.id %> )'   style=""> Edit    </a> 
            |
                <a  href='javascript: doSectionDel( <%= section.id %> )'    style=""> Del     </a> 
            |
                <a  href='javascript: doSectionOnward( <%= section.id %> )' style=""> Onward  </a> 
          </div>
        </div>
      </div>

    <% end %>

</div>

<script language='javascript'>

  jQuery().ready(function(){ 
    App = {};
    App.chartId = '<%= @chart.id %>';
    buildFlowChart( <%= @chart.sections_connections.to_json %>);
  });

  function buildFlowChart( edges ) {

    jsPlumb.Defaults.Connector = [ "Flowchart" ];
    var connectorPaintStyle = { lineWidth:3, strokeStyle: "#346789" };

    if ( typeof(edges) == 'undefined' ) return;

    // Build connector attributes
    var targetOption = { 
        maxConnections:-1,
        endpoint:["Dot", {radius:5}],
        paintStyle:{fillStyle:"#FFEF00"},
        setDragAllowedWhenFull:true,
        anchor:"TopCenter",
        isSource:false,
        isTarget:true
    };
    // .. deep copy/clone the object and alter a few bits..
    var sourceOption = jQuery.extend(true, {}, targetOption);
    sourceOption.isSource = true;
    sourceOption.isTarget = false;
    sourceOption.anchor   = "BottomCenter";

    for( var i=0; i < edges.length; i++ ) {
      var edge = edges[i];

      var overlays = [
          [ "Arrow", { location:0.5 } ],
          [ "Label", { location:0.8, label: "EDGE", cssClass: "edge-label" } ]
      ];

      fromID = 'section-' + edge[0];
      toID   = 'section-' + edge[1];

      source_ep = jsPlumb.addEndpoint(fromID, sourceOption);
      target_ep = jsPlumb.addEndpoint(toID, targetOption);
      //jsPlumb.draggable(fromID); 
      jsPlumb.draggable(toID);
      jsPlumb.connect({ source: source_ep, target: target_ep, overlays:overlays });
    }
  }

  function doSectionDel( sectionId ) { 
  }

  function doSectionOnward( sectionId ) { 
    jQuery('#section-builder').html('<h2>' + sectionId + '</h2>');
  }

  function doSectionEdit( sectionId ) { 

    // setup some divs to take section title and section lines
    jQuery('#section-builder').html('<div id="section-builder-title"></div>'
      + '<div class="accordion" id="section-builder-lines"> loading... </div>'
    );

    // kickoff ajax to get section detail
    jQuery.ajax({
      url: '/sections/' + sectionId,
      dataType: 'json',
      success: function(json){
        var section = json.section
        // setup div for tool  and fill in section name 
        jQuery('#section-builder-title').html('<h3>' + section.name + '</h3><span id="tools"></span>');
        // load some tools
        doToolsLoad( sectionId );
        // clear section line builder and loop through each section line id
        jQuery('#section-builder-lines').html('');
        for( var i in section.section_lines ) {
          sectionLineId =  section.section_lines[i];
          doSectionLineEdit( sectionLineId, sectionId );
        }
      }
    });
  }

  function doToolsLoad(sectionId) { 
    jQuery.ajax({
      url: '/tools',
      dataType: 'json',
      success: function(json){
        var tools = json.tools
        var li_tools = '';
        // loop building string of html list items
        for( var i in tools ) {
          tool = tools[i];
          li_tools = li_tools + '<li><a href="javascript: addSectionLine('+tool.id+', '+ sectionId +') ">'+tool.name+'</a></li>';
        }
        // set the div with the list of tools
        jQuery('#tools').html(
          '<div class="btn-group">'
          + '<a class="btn dropdown-toggle" data-toggle="dropdown" href="#">'
          + 'Tools'
          + '<span class="caret"></span>'
          + '</a>'
          + '  <ul class="dropdown-menu">' + li_tools + '</ul>'
          + '</div>'
        );
      }
    });
  }

  function doSectionLineEdit( sectionLineId, sectionId ) { 
    jQuery.ajax({
      url: '/section_lines/' + sectionLineId,
      dataType: 'json',
      success: function(json){
        var sectionLine = json.section_line
        var slColId = 'sectionLineCollapse' + sectionLine.id
        jQuery('#section-builder-lines').append(
          '<div class="accordion-group" id="section-line-' + sectionLine.id + '">'
          + '  <div class="accordion-heading">'
          + '    <a href="javascript: delSectionLine('+sectionLineId+','+sectionId+')" class="pull-right">x</a>'
          + '    <a class="accordion-toggle" data-toggle="collapse" data-parent="#section-builder-lines" href="#' + slColId + '">'
          + 'Section Line ' + sectionLine.id
          + '    </a>'
          + '  </div>'
          + '  <div id="' + slColId + '" class="accordion-body collapse">'
          + '    <div class="accordion-inner">'
          + sectionLine.edit_html
          + '    </div>'
          + '  </div>'
          + '</div>'
        );
      }
    });
  }

  function addSectionLine( toolId, sectionId ) {
    jQuery.post('/charts/'+App.chartId+'/sections/'+sectionId+'/section_lines', { tool_id: toolId }, function(json){
      var sectionLine = json.section_line
      doSectionLineEdit(sectionLine.id, sectionId);
    });
  }

  function delSectionLine( sectionLineId, sectionId ) {
    jQuery.ajax({
        url: '/charts/'+App.chartId+'/sections/'+sectionId+'/section_lines/' + sectionLineId,
        type: 'DELETE',
    }).done(function( json ) {
        jQuery('#section-line-' + sectionLineId).remove();
    });
  }

</script>


